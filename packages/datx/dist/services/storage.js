"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mobx_1 = require("mobx");
var utils_1 = require("../helpers/model/utils");
var selectors_1 = require("../helpers/selectors");
var utils_2 = require("../helpers/utils");
var DataStorage = /** @class */ (function () {
    function DataStorage() {
        this.modelData = new WeakMap();
        this.modelClassData = new WeakMap();
        this.collections = mobx_1.observable.shallowArray([]);
    }
    DataStorage.prototype.initModel = function (model) {
        var modelData = { data: {}, meta: {} };
        mobx_1.extendObservable(modelData);
        this.modelData.set(model, modelData);
        return modelData;
    };
    DataStorage.prototype.getModelData = function (model) {
        return this.__getModelData(model).data;
    };
    DataStorage.prototype.getModelDataKey = function (model, key) {
        var modelData = this.__getModelData(model);
        return modelData.data[key];
    };
    DataStorage.prototype.setModelData = function (model, data) {
        var modelData = this.__getModelData(model);
        mobx_1.extendObservable(modelData.data, data);
    };
    DataStorage.prototype.setModelDataKey = function (model, key, value) {
        this.setModelData(model, (_a = {}, _a[key] = value, _a));
        var _a;
    };
    DataStorage.prototype.getModelMeta = function (model) {
        return this.modelData.get(model).meta;
    };
    DataStorage.prototype.getModelMetaKey = function (model, key) {
        return this.getModelMeta(model)[key];
    };
    DataStorage.prototype.setModelMeta = function (model, meta) {
        var modelData = this.__getModelData(model);
        mobx_1.extendObservable(modelData.meta, meta);
        return modelData.meta;
    };
    DataStorage.prototype.setModelMetaKey = function (model, key, value) {
        this.setModelMeta(model, (_a = {}, _a[key] = value, _a));
        var _a;
    };
    DataStorage.prototype.getAllModels = function () {
        var models = this.collections.map(function (collection) { return Array.from(collection.findAll()); });
        return utils_2.uniq(utils_2.flatten(models));
    };
    DataStorage.prototype.setModelClassMetaKey = function (model, key, value) {
        var data = this.modelClassData.get(model);
        Object.assign(data.meta, (_a = {}, _a[key] = value, _a));
        var _a;
    };
    DataStorage.prototype.getModelClassMetaKey = function (obj, key) {
        var _this = this;
        return selectors_1.reducePrototypeChain(obj, function (value, model) {
            return value || (_this.modelClassData.get(model) || { meta: {} }).meta[key] || null;
        }, null);
    };
    DataStorage.prototype.addModelDefaultField = function (model, key, value) {
        var data = this.modelClassData.get(model);
        if (data) {
            Object.assign(data.data, (_a = {}, _a[key] = value, _a));
        }
        else {
            this.modelClassData.set(model, {
                data: (_b = {}, _b[key] = value, _b),
                meta: {},
                references: {},
            });
        }
        var _a, _b;
    };
    DataStorage.prototype.getModelDefaults = function (obj) {
        var _this = this;
        var defaults = selectors_1.reducePrototypeChain(obj, function (state, model) {
            return state.concat((_this.modelClassData.get(model) || { data: [] }).data);
        }, []);
        return Object.assign.apply(Object, [{}].concat(defaults.reverse()));
    };
    DataStorage.prototype.registerCollection = function (collection) {
        this.collections.push(collection);
    };
    DataStorage.prototype.unregisterCollection = function (collection) {
        this.collections.remove(collection);
    };
    DataStorage.prototype.getModelCollections = function (model) {
        return this.collections.filter(function (item) { return item.hasItem(model); });
    };
    DataStorage.prototype.findModel = function (model, modelId) {
        if (modelId !== null && modelId !== undefined) {
            var type = utils_1.getModelType(model);
            var id = utils_1.getModelId(modelId);
            for (var _i = 0, _a = this.collections; _i < _a.length; _i++) {
                var collection = _a[_i];
                var item = collection.find(type, id);
                if (item) {
                    return item;
                }
            }
        }
        return null;
    };
    DataStorage.prototype.addModelClassReference = function (model, key, options) {
        var data = this.modelClassData.get(model);
        if (data) {
            Object.assign(data.references, (_a = {}, _a[key] = options, _a));
        }
        else {
            this.modelClassData.set(model, {
                data: {},
                meta: {},
                references: (_b = {}, _b[key] = options, _b),
            });
        }
        var _a, _b;
    };
    DataStorage.prototype.getModelClassReferences = function (obj) {
        var _this = this;
        var defaults = selectors_1.reducePrototypeChain(obj, function (state, model) {
            return state.concat((_this.modelClassData.get(model) || { references: {} }).references);
        }, []);
        return Object.assign.apply(Object, [{}].concat(defaults.reverse()));
    };
    DataStorage.prototype.getModelReferenceOptions = function (model, key) {
        var refs = this.getModelMetaKey(model, 'refs');
        return refs[key];
    };
    DataStorage.prototype.getModelsByType = function (type) {
        var models = this.collections.map(function (collection) { return Array.from(collection.findAll(type)); });
        return utils_2.uniq(utils_2.flatten(models));
    };
    DataStorage.prototype.__getModelData = function (model) {
        return this.modelData.get(model) || this.initModel(model);
    };
    // For testing purposes only
    DataStorage.prototype.clear = function () {
        this.modelData = new WeakMap();
        this.modelClassData = new WeakMap();
        this.collections.replace([]);
    };
    return DataStorage;
}());
exports.DataStorage = DataStorage;
exports.storage = new DataStorage();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9zdG9yYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQW9GO0FBR3BGLGdEQUFnRTtBQUNoRSxrREFBMEQ7QUFDMUQsMENBQStDO0FBYy9DO0lBQUE7UUFDVSxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQXVCLENBQUM7UUFFL0MsbUJBQWMsR0FBRyxJQUFJLE9BQU8sRUFBaUMsQ0FBQztRQUU5RCxnQkFBVyxHQUFpQyxpQkFBVSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQW1KbEYsQ0FBQztJQWpKUSwrQkFBUyxHQUFoQixVQUFpQixLQUFZO1FBQzNCLElBQU0sU0FBUyxHQUFHLEVBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFDLENBQUM7UUFDdkMsdUJBQWdCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sQ0FBQyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVNLGtDQUFZLEdBQW5CLFVBQW9CLEtBQVk7UUFDOUIsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3pDLENBQUM7SUFFTSxxQ0FBZSxHQUF0QixVQUF1QixLQUFZLEVBQUUsR0FBVztRQUM5QyxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTSxrQ0FBWSxHQUFuQixVQUFvQixLQUFZLEVBQUUsSUFBc0I7UUFDdEQsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FB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O1FBQ3BELElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxPQUFPLEVBQWlDLENBQUM7UUFDbkUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUNILGtCQUFDO0FBQUQsQ0FBQyxBQXhKRCxJQXdKQztBQXhKWSxrQ0FBVztBQTBKWCxRQUFBLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtjb21wdXRlZCwgZXh0ZW5kT2JzZXJ2YWJsZSwgSU9ic2VydmFibGVBcnJheSwgb2JzZXJ2YWJsZSwgdG9KU30gZnJvbSAnbW9ieCc7XG5cbmltcG9ydCB7Q29sbGVjdGlvbn0gZnJvbSAnLi4vQ29sbGVjdGlvbic7XG5pbXBvcnQge2dldE1vZGVsSWQsIGdldE1vZGVsVHlwZX0gZnJvbSAnLi4vaGVscGVycy9tb2RlbC91dGlscyc7XG5pbXBvcnQge3JlZHVjZVByb3RvdHlwZUNoYWlufSBmcm9tICcuLi9oZWxwZXJzL3NlbGVjdG9ycyc7XG5pbXBvcnQge2ZsYXR0ZW4sIHVuaXF9IGZyb20gJy4uL2hlbHBlcnMvdXRpbHMnO1xuaW1wb3J0IHtJRGF0YVN0b3JhZ2V9IGZyb20gJy4uL2ludGVyZmFjZXMvSURhdGFTdG9yYWdlJztcbmltcG9ydCB7SURpY3Rpb25hcnl9IGZyb20gJy4uL2ludGVyZmFjZXMvSURpY3Rpb25hcnknO1xuaW1wb3J0IHtJSWRlbnRpZmllcn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9JSWRlbnRpZmllcic7XG5pbXBvcnQge0lSZWZlcmVuY2VPcHRpb25zfSBmcm9tICcuLi9pbnRlcmZhY2VzL0lSZWZlcmVuY2VPcHRpb25zJztcbmltcG9ydCB7SVR5cGV9IGZyb20gJy4uL2ludGVyZmFjZXMvSVR5cGUnO1xuaW1wb3J0IHtNb2RlbH0gZnJvbSAnLi4vTW9kZWwnO1xuXG5pbnRlcmZhY2UgSU1vZGVsQ2xhc3NEYXRhIHtcbiAgZGF0YTogSURpY3Rpb25hcnk8YW55PjtcbiAgbWV0YTogSURpY3Rpb25hcnk8YW55PjtcbiAgcmVmZXJlbmNlczogSURpY3Rpb25hcnk8SVJlZmVyZW5jZU9wdGlvbnM+O1xufVxuXG5leHBvcnQgY2xhc3MgRGF0YVN0b3JhZ2Uge1xuICBwcml2YXRlIG1vZGVsRGF0YSA9IG5ldyBXZWFrTWFwPE1vZGVsLCBJRGF0YVN0b3JhZ2U+KCk7XG5cbiAgcHJpdmF0ZSBtb2RlbENsYXNzRGF0YSA9IG5ldyBXZWFrTWFwPHR5cGVvZiBNb2RlbCwgSU1vZGVsQ2xhc3NEYXRhPigpO1xuXG4gIHByaXZhdGUgY29sbGVjdGlvbnM6IElPYnNlcnZhYmxlQXJyYXk8Q29sbGVjdGlvbj4gPSBvYnNlcnZhYmxlLnNoYWxsb3dBcnJheShbXSk7XG5cbiAgcHVibGljIGluaXRNb2RlbChtb2RlbDogTW9kZWwpIHtcbiAgICBjb25zdCBtb2RlbERhdGEgPSB7ZGF0YToge30sIG1ldGE6IHt9fTtcbiAgICBleHRlbmRPYnNlcnZhYmxlKG1vZGVsRGF0YSk7XG4gICAgdGhpcy5tb2RlbERhdGEuc2V0KG1vZGVsLCBtb2RlbERhdGEpO1xuICAgIHJldHVybiBtb2RlbERhdGE7XG4gIH1cblxuICBwdWJsaWMgZ2V0TW9kZWxEYXRhKG1vZGVsOiBNb2RlbCkge1xuICAgIHJldHVybiB0aGlzLl9fZ2V0TW9kZWxEYXRhKG1vZGVsKS5kYXRhO1xuICB9XG5cbiAgcHVibGljIGdldE1vZGVsRGF0YUtleShtb2RlbDogTW9kZWwsIGtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgbW9kZWxEYXRhID0gdGhpcy5fX2dldE1vZGVsRGF0YShtb2RlbCk7XG4gICAgcmV0dXJuIG1vZGVsRGF0YS5kYXRhW2tleV07XG4gIH1cblxuICBwdWJsaWMgc2V0TW9kZWxEYXRhKG1vZGVsOiBNb2RlbCwgZGF0YTogSURpY3Rpb25hcnk8YW55Pikge1xuICAgIGNvbnN0IG1vZGVsRGF0YSA9IHRoaXMuX19nZXRNb2RlbERhdGEobW9kZWwpO1xuICAgIGV4dGVuZE9ic2VydmFibGUobW9kZWxEYXRhLmRhdGEsIGRhdGEpO1xuICB9XG5cbiAgcHVibGljIHNldE1vZGVsRGF0YUtleShtb2RlbDogTW9kZWwsIGtleTogc3RyaW5nLCB2YWx1ZT86IGFueSkge1xuICAgIHRoaXMuc2V0TW9kZWxEYXRhKG1vZGVsLCB7W2tleV06IHZhbHVlfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0TW9kZWxNZXRhKG1vZGVsOiBNb2RlbCk6IElEaWN0aW9uYXJ5PGFueT4ge1xuICAgIHJldHVybiAodGhpcy5tb2RlbERhdGEuZ2V0KG1vZGVsKSBhcyBJRGF0YVN0b3JhZ2UpLm1ldGE7XG4gIH1cblxuICBwdWJsaWMgZ2V0TW9kZWxNZXRhS2V5KG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLmdldE1vZGVsTWV0YShtb2RlbClba2V5XTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRNb2RlbE1ldGEobW9kZWw6IE1vZGVsLCBtZXRhOiBJRGljdGlvbmFyeTxhbnk+KSB7XG4gICAgY29uc3QgbW9kZWxEYXRhID0gdGhpcy5fX2dldE1vZGVsRGF0YShtb2RlbCk7XG4gICAgZXh0ZW5kT2JzZXJ2YWJsZShtb2RlbERhdGEubWV0YSwgbWV0YSk7XG4gICAgcmV0dXJuIG1vZGVsRGF0YS5tZXRhO1xuICB9XG5cbiAgcHVibGljIHNldE1vZGVsTWV0YUtleShtb2RlbDogTW9kZWwsIGtleTogc3RyaW5nLCB2YWx1ZT86IGFueSkge1xuICAgIHRoaXMuc2V0TW9kZWxNZXRhKG1vZGVsLCB7W2tleV06IHZhbHVlfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0QWxsTW9kZWxzKCkge1xuICAgIGNvbnN0IG1vZGVscyA9IHRoaXMuY29sbGVjdGlvbnMubWFwKChjb2xsZWN0aW9uKSA9PiBBcnJheS5mcm9tKGNvbGxlY3Rpb24uZmluZEFsbCgpKSk7XG4gICAgcmV0dXJuIHVuaXEoZmxhdHRlbihtb2RlbHMpKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRNb2RlbENsYXNzTWV0YUtleShtb2RlbDogdHlwZW9mIE1vZGVsLCBrZXk6IHN0cmluZywgdmFsdWU/OiBhbnkpIHtcbiAgICBjb25zdCBkYXRhID0gdGhpcy5tb2RlbENsYXNzRGF0YS5nZXQobW9kZWwpIGFzIElNb2RlbENsYXNzRGF0YTtcbiAgICBPYmplY3QuYXNzaWduKGRhdGEubWV0YSwge1trZXldOiB2YWx1ZX0pO1xuICB9XG5cbiAgcHVibGljIGdldE1vZGVsQ2xhc3NNZXRhS2V5KG9iajogdHlwZW9mIE1vZGVsLCBrZXk6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIHJlZHVjZVByb3RvdHlwZUNoYWluKG9iaiwgKHZhbHVlLCBtb2RlbCkgPT4ge1xuICAgICAgcmV0dXJuIHZhbHVlIHx8ICh0aGlzLm1vZGVsQ2xhc3NEYXRhLmdldChtb2RlbCkgfHwge21ldGE6IHt9fSkubWV0YVtrZXldIHx8IG51bGw7XG4gICAgfSwgbnVsbCk7XG4gIH1cblxuICBwdWJsaWMgYWRkTW9kZWxEZWZhdWx0RmllbGQobW9kZWw6IHR5cGVvZiBNb2RlbCwga2V5OiBzdHJpbmcsIHZhbHVlPzogYW55KSB7XG4gICAgY29uc3QgZGF0YSA9IHRoaXMubW9kZWxDbGFzc0RhdGEuZ2V0KG1vZGVsKTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgT2JqZWN0LmFzc2lnbihkYXRhLmRhdGEsIHtba2V5XTogdmFsdWV9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tb2RlbENsYXNzRGF0YS5zZXQobW9kZWwsIHtcbiAgICAgICAgZGF0YToge1trZXldOiB2YWx1ZX0sXG4gICAgICAgIG1ldGE6IHt9LFxuICAgICAgICByZWZlcmVuY2VzOiB7fSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRNb2RlbERlZmF1bHRzKG9iajogdHlwZW9mIE1vZGVsKTogSURpY3Rpb25hcnk8YW55PiB7XG4gICAgY29uc3QgZGVmYXVsdHMgPSByZWR1Y2VQcm90b3R5cGVDaGFpbihvYmosIChzdGF0ZSwgbW9kZWwpID0+IHtcbiAgICAgIHJldHVybiBzdGF0ZS5jb25jYXQoKHRoaXMubW9kZWxDbGFzc0RhdGEuZ2V0KG1vZGVsKSB8fCB7ZGF0YTogW119KS5kYXRhKTtcbiAgICB9LCBbXSBhcyBBcnJheTxJRGljdGlvbmFyeTxhbnk+Pik7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIC4uLmRlZmF1bHRzLnJldmVyc2UoKSk7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXJDb2xsZWN0aW9uKGNvbGxlY3Rpb246IENvbGxlY3Rpb24pIHtcbiAgICB0aGlzLmNvbGxlY3Rpb25zLnB1c2goY29sbGVjdGlvbik7XG4gIH1cblxuICBwdWJsaWMgdW5yZWdpc3RlckNvbGxlY3Rpb24oY29sbGVjdGlvbjogQ29sbGVjdGlvbikge1xuICAgIHRoaXMuY29sbGVjdGlvbnMucmVtb3ZlKGNvbGxlY3Rpb24pO1xuICB9XG5cbiAgcHVibGljIGdldE1vZGVsQ29sbGVjdGlvbnMobW9kZWw6IE1vZGVsKTogQXJyYXk8Q29sbGVjdGlvbj4ge1xuICAgIHJldHVybiB0aGlzLmNvbGxlY3Rpb25zLmZpbHRlcigoaXRlbSkgPT4gaXRlbS5oYXNJdGVtKG1vZGVsKSk7XG4gIH1cblxuICBwdWJsaWMgZmluZE1vZGVsKG1vZGVsOiBJVHlwZXx0eXBlb2YgTW9kZWx8TW9kZWwsIG1vZGVsSWQ6IE1vZGVsfElJZGVudGlmaWVyfG51bGwpOiBNb2RlbHxudWxsIHtcbiAgICBpZiAobW9kZWxJZCAhPT0gbnVsbCAmJiBtb2RlbElkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHR5cGUgPSBnZXRNb2RlbFR5cGUobW9kZWwpO1xuICAgICAgY29uc3QgaWQgPSBnZXRNb2RlbElkKG1vZGVsSWQpO1xuICAgICAgZm9yIChjb25zdCBjb2xsZWN0aW9uIG9mIHRoaXMuY29sbGVjdGlvbnMpIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IGNvbGxlY3Rpb24uZmluZCh0eXBlLCBpZCk7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwdWJsaWMgYWRkTW9kZWxDbGFzc1JlZmVyZW5jZShtb2RlbDogdHlwZW9mIE1vZGVsLCBrZXk6IHN0cmluZywgb3B0aW9uczogSVJlZmVyZW5jZU9wdGlvbnMpIHtcbiAgICBjb25zdCBkYXRhID0gdGhpcy5tb2RlbENsYXNzRGF0YS5nZXQobW9kZWwpO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBPYmplY3QuYXNzaWduKGRhdGEucmVmZXJlbmNlcywge1trZXldOiBvcHRpb25zfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubW9kZWxDbGFzc0RhdGEuc2V0KG1vZGVsLCB7XG4gICAgICAgIGRhdGE6IHt9LFxuICAgICAgICBtZXRhOiB7fSxcbiAgICAgICAgcmVmZXJlbmNlczoge1trZXldOiBvcHRpb25zfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRNb2RlbENsYXNzUmVmZXJlbmNlcyhvYmo6IHR5cGVvZiBNb2RlbCk6IElEaWN0aW9uYXJ5PElSZWZlcmVuY2VPcHRpb25zPiB7XG4gICAgY29uc3QgZGVmYXVsdHMgPSByZWR1Y2VQcm90b3R5cGVDaGFpbihvYmosIChzdGF0ZSwgbW9kZWwpID0+IHtcbiAgICAgIHJldHVybiBzdGF0ZS5jb25jYXQoKHRoaXMubW9kZWxDbGFzc0RhdGEuZ2V0KG1vZGVsKSB8fCB7cmVmZXJlbmNlczoge319KS5yZWZlcmVuY2VzKTtcbiAgICB9LCBbXSBhcyBBcnJheTxJRGljdGlvbmFyeTxhbnk+Pik7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIC4uLmRlZmF1bHRzLnJldmVyc2UoKSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcpOiBJUmVmZXJlbmNlT3B0aW9ucyB7XG4gICAgY29uc3QgcmVmcyA9IHRoaXMuZ2V0TW9kZWxNZXRhS2V5KG1vZGVsLCAncmVmcycpO1xuICAgIHJldHVybiByZWZzW2tleV07XG4gIH1cblxuICBwdWJsaWMgZ2V0TW9kZWxzQnlUeXBlKHR5cGU6IElUeXBlKSB7XG4gICAgY29uc3QgbW9kZWxzID0gdGhpcy5jb2xsZWN0aW9ucy5tYXAoKGNvbGxlY3Rpb24pID0+IEFycmF5LmZyb20oY29sbGVjdGlvbi5maW5kQWxsKHR5cGUpKSk7XG4gICAgcmV0dXJuIHVuaXEoZmxhdHRlbihtb2RlbHMpKTtcbiAgfVxuXG4gIHByaXZhdGUgX19nZXRNb2RlbERhdGEobW9kZWw6IE1vZGVsKTogSURhdGFTdG9yYWdlIHtcbiAgICByZXR1cm4gdGhpcy5tb2RlbERhdGEuZ2V0KG1vZGVsKSB8fCB0aGlzLmluaXRNb2RlbChtb2RlbCk7XG4gIH1cblxuICAvLyBGb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5XG4gIHByaXZhdGUgY2xlYXIoKSB7XG4gICAgdGhpcy5tb2RlbERhdGEgPSBuZXcgV2Vha01hcDxNb2RlbCwgSURhdGFTdG9yYWdlPigpO1xuICAgIHRoaXMubW9kZWxDbGFzc0RhdGEgPSBuZXcgV2Vha01hcDx0eXBlb2YgTW9kZWwsIElNb2RlbENsYXNzRGF0YT4oKTtcbiAgICB0aGlzLmNvbGxlY3Rpb25zLnJlcGxhY2UoW10pO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBzdG9yYWdlID0gbmV3IERhdGFTdG9yYWdlKCk7XG4iXX0=