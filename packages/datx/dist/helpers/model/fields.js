"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mobx_1 = require("mobx");
var FieldType_1 = require("../../enums/FieldType");
var ReferenceType_1 = require("../../enums/ReferenceType");
var errors_1 = require("../../errors");
var Model_1 = require("../../Model");
var storage_1 = require("../../services/storage");
var format_1 = require("../format");
var utils_1 = require("../utils");
var utils_2 = require("./utils");
function modelAddReference(model, key, newReference) {
    var refOptions = storage_1.storage.getModelReferenceOptions(model, key);
    var newRefId = utils_2.getModelId(newReference);
    var data = storage_1.storage.getModelDataKey(model, key);
    if (refOptions.type === ReferenceType_1.ReferenceType.TO_ONE) {
        storage_1.storage.setModelDataKey(model, key, newRefId);
    }
    else if (refOptions.type === ReferenceType_1.ReferenceType.TO_MANY || mobx_1.isObservableArray(data)) {
        data.push(newRefId);
    }
    else {
        storage_1.storage.setModelDataKey(model, key, newReference);
    }
}
function modelRemoveReference(model, key, oldReference) {
    var refOptions = storage_1.storage.getModelReferenceOptions(model, key);
    var oldRefId = utils_2.getModelId(oldReference);
    var data = storage_1.storage.getModelDataKey(model, key);
    if (refOptions.type === ReferenceType_1.ReferenceType.TO_ONE) {
        storage_1.storage.setModelDataKey(model, key, null);
    }
    else if (refOptions.type === ReferenceType_1.ReferenceType.TO_MANY || mobx_1.isObservableArray(data)) {
        data.remove(oldRefId);
    }
    else {
        storage_1.storage.setModelDataKey(model, key, null);
    }
}
function partialRefUpdate(model, key, change) {
    var refOptions = storage_1.storage.getModelReferenceOptions(model, key);
    var data = storage_1.storage.getModelDataKey(model, key);
    if (change.type === 'splice') {
        var added = change.added.map(utils_2.getModelId);
        data.splice.apply(data, [change.index, change.removedCount].concat(added));
        return null;
    }
    data[change.index] = utils_2.getModelId(change.newValue);
    return null;
}
function backRefSplice(model, key, change, refOptions) {
    var property = refOptions.property;
    change.added.map(function (item) { return modelAddReference(item, property, model); });
    var removed = model[key].slice(change.index, change.index + change.removedCount);
    removed.map(function (item) { return modelRemoveReference(item, property, model); });
    return null;
}
function backRefChange(model, key, change, refOptions) {
    var property = refOptions.property;
    var oldValue = model[key].length > change.index ? model[key][change.index] : null;
    if (change.newValue) {
        modelAddReference(change.newValue, property, model);
    }
    if (oldValue) {
        modelRemoveReference(oldValue, property, model);
    }
    return null;
}
function partialBackRefUpdate(model, key, change) {
    var refOptions = storage_1.storage.getModelReferenceOptions(model, key);
    if (change.type === 'splice') {
        return backRefSplice(model, key, change, refOptions);
    }
    return backRefChange(model, key, change, refOptions);
}
function getField(model, key) {
    return storage_1.storage.getModelDataKey(model, key);
}
exports.getField = getField;
function updateField(model, key, value, type) {
    if (type === FieldType_1.FieldType.TYPE) {
        throw format_1.error(errors_1.TYPE_READONLY);
    }
    else if (type === FieldType_1.FieldType.ID) {
        throw format_1.error(errors_1.ID_READONLY);
    }
    storage_1.storage.setModelDataKey(model, key, value);
}
exports.updateField = updateField;
function hasBackRef(item, property, target) {
    if (item[property] === null || item[property] === undefined) {
        return false;
    }
    else if (item[property] instanceof Model_1.Model) {
        return item[property] === target;
    }
    else {
        return item[property].indexOf(target) !== -1;
    }
}
function getBackRef(model, key, refOptions) {
    var type = utils_2.getModelType(refOptions.model);
    var allModels = storage_1.storage.getModelsByType(type);
    var backModels = Object.keys(allModels)
        .map(function (id) { return allModels[id]; })
        .filter(function (item) { return hasBackRef(item, refOptions.property, model); });
    var backData = mobx_1.observable.shallowArray(backModels);
    mobx_1.intercept(backData, function (change) { return partialBackRefUpdate(model, key, change); });
    return backData;
}
function getNormalRef(model, key, refOptions) {
    var value = storage_1.storage.getModelDataKey(model, key);
    var dataModels = utils_1.mapItems(value, function (id) { return storage_1.storage.findModel(refOptions.model, id); });
    if (dataModels instanceof Array) {
        var data = mobx_1.observable.shallowArray(dataModels);
        mobx_1.intercept(data, function (change) { return partialRefUpdate(model, key, change); });
        return data;
    }
    return dataModels;
}
function getRef(model, key) {
    var refOptions = storage_1.storage.getModelReferenceOptions(model, key);
    return (typeof refOptions.property === 'string')
        ? getBackRef(model, key, refOptions)
        : getNormalRef(model, key, refOptions);
}
exports.getRef = getRef;
function validateRef(refOptions, isArray, key) {
    if (refOptions.type === ReferenceType_1.ReferenceType.TO_ONE && isArray) {
        throw format_1.error(errors_1.REF_SINGLE, { key: key });
    }
    else if (refOptions.type === ReferenceType_1.ReferenceType.TO_MANY && !isArray) {
        throw format_1.error(errors_1.REF_ARRAY, { key: key });
    }
    else if (refOptions.property) {
        throw format_1.error(errors_1.BACK_REF_READ_ONLY);
    }
}
function updateRef(model, key, value) {
    var refOptions = storage_1.storage.getModelReferenceOptions(model, key);
    var ids = refOptions.type === ReferenceType_1.ReferenceType.TO_MANY
        ? (utils_1.mapItems(value, utils_2.getModelId) || [])
        : utils_1.mapItems(value, utils_2.getModelId);
    validateRef(refOptions, ids instanceof Array, key);
    var referencedModels = utils_1.mapItems(value, function (ref) { return storage_1.storage.findModel(refOptions.model, ref); });
    var isInvalidArray = utils_1.isFalsyArray(referencedModels) && value.length;
    var isInvalidModel = Boolean(value) && !referencedModels;
    if (isInvalidArray || isInvalidModel) {
        throw format_1.error(errors_1.REF_NEEDS_COLLECTION);
    }
    storage_1.storage.setModelDataKey(model, key, ids);
}
exports.updateRef = updateRef;
function getModelRefsByType(model, type) {
    var refs = storage_1.storage.getModelMetaKey(model, 'refs');
    return Object.keys(refs)
        .filter(function (key) { return !refs[key].property; })
        .filter(function (key) { return utils_2.getModelType(refs[key].model) === type; });
}
function updateModelReferences(newId, oldId, type) {
    var allModels = storage_1.storage.getAllModels().map(function (item) {
        getModelRefsByType(item, type).forEach(function (ref) {
            var data = storage_1.storage.getModelDataKey(item, ref);
            if (data instanceof Array || mobx_1.isObservableArray(data)) {
                var targetIndex = data.indexOf(oldId);
                if (targetIndex !== -1) {
                    data[targetIndex] = newId;
                }
            }
            else if (data === oldId) {
                storage_1.storage.setModelDataKey(item, ref, newId);
            }
        });
    });
}
/**
 * Updates the model identifier and all the existing references to the model
 *
 * @export
 * @param {Model} model Model to be updated
 * @param {IIdentifier} newId New model identifier
 */
function updateModelId(model, newId) {
    var collections = utils_2.getModelCollections(model);
    var oldId = utils_2.getModelId(model);
    var type = utils_2.getModelType(model);
    storage_1.storage.setModelMetaKey(model, 'id', newId);
    var staticModel = model.constructor;
    var modelId = storage_1.storage.getModelClassMetaKey(staticModel, 'id');
    if (modelId) {
        storage_1.storage.setModelDataKey(model, modelId, newId);
    }
    collections.forEach(function (collection) {
        // @ts-ignore - I'm bad and I should feel bad...
        collection.__changeModelId(oldId, newId, type);
    });
    updateModelReferences(newId, oldId, type);
}
exports.updateModelId = updateModelId;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2hlbHBlcnMvbW9kZWwvZmllbGRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTRHO0FBRTVHLG1EQUFnRDtBQUNoRCwyREFBd0Q7QUFDeEQsdUNBT3NCO0FBTXRCLHFDQUFrQztBQUNsQyxrREFBK0M7QUFDL0Msb0NBQWdDO0FBQ2hDLGtDQUFnRDtBQUNoRCxpQ0FBc0U7QUFFdEUsMkJBQTJCLEtBQVksRUFBRSxHQUFXLEVBQUUsWUFBbUI7SUFDdkUsSUFBTSxVQUFVLEdBQUcsaUJBQU8sQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDaEUsSUFBTSxRQUFRLEdBQUcsa0JBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUMxQyxJQUFNLElBQUksR0FBRyxpQkFBTyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDakQsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyw2QkFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDN0MsaUJBQU8sQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEtBQUssNkJBQWEsQ0FBQyxPQUFPLElBQUksd0JBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hGLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04saUJBQU8sQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNwRCxDQUFDO0FBQ0gsQ0FBQztBQUVELDhCQUE4QixLQUFZLEVBQUUsR0FBVyxFQUFF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S0FBSyxDQUFDLENBQUM7SUFDaEMsSUFBTSxJQUFJLEdBQUcsb0JBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqQyxpQkFBTyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRTVDLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUEyQixDQUFDO0lBQ3RELElBQU0sT0FBTyxHQUFHLGlCQUFPLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2hFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDWixpQkFBTyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQUMsVUFBVTtRQUM3QixnREFBZ0Q7UUFDaEQsVUFBVSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUMsQ0FBQyxDQUFDO0lBRUgscUJBQXFCLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztBQUM1QyxDQUFDO0FBbkJELHNDQW1CQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SUFycmF5Q2hhbmdlLCBJQXJyYXlTcGxpY2UsIGludGVyY2VwdCwgSU9ic2VydmFibGVBcnJheSwgaXNPYnNlcnZhYmxlQXJyYXksIG9ic2VydmFibGV9IGZyb20gJ21vYngnO1xuXG5pbXBvcnQge0ZpZWxkVHlwZX0gZnJvbSAnLi4vLi4vZW51bXMvRmllbGRUeXBlJztcbmltcG9ydCB7UmVmZXJlbmNlVHlwZX0gZnJvbSAnLi4vLi4vZW51bXMvUmVmZXJlbmNlVHlwZSc7XG5pbXBvcnQge1xuICBCQUNLX1JFRl9SRUFEX09OTFksXG4gIElEX1JFQURPTkxZLFxuICBSRUZfQVJSQVksXG4gIFJFRl9ORUVEU19DT0xMRUNUSU9OLFxuICBSRUZfU0lOR0xFLFxuICBUWVBFX1JFQURPTkxZLFxufSBmcm9tICcuLi8uLi9lcnJvcnMnO1xuaW1wb3J0IHtJSWRlbnRpZmllcn0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JSWRlbnRpZmllcic7XG5pbXBvcnQge0lSZWZlcmVuY2VPcHRpb25zfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL0lSZWZlcmVuY2VPcHRpb25zJztcbmltcG9ydCB7SVR5cGV9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSVR5cGUnO1xuaW1wb3J0IHtUQ2hhbmdlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL1RDaGFuZ2UnO1xuaW1wb3J0IHtUUmVmVmFsdWV9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvVFJlZlZhbHVlJztcbmltcG9ydCB7TW9kZWx9IGZyb20gJy4uLy4uL01vZGVsJztcbmltcG9ydCB7c3RvcmFnZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvc3RvcmFnZSc7XG5pbXBvcnQge2Vycm9yfSBmcm9tICcuLi9mb3JtYXQnO1xuaW1wb3J0IHtpc0ZhbHN5QXJyYXksIG1hcEl0ZW1zfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQge2dldE1vZGVsQ29sbGVjdGlvbnMsIGdldE1vZGVsSWQsIGdldE1vZGVsVHlwZX0gZnJvbSAnLi91dGlscyc7XG5cbmZ1bmN0aW9uIG1vZGVsQWRkUmVmZXJlbmNlKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcsIG5ld1JlZmVyZW5jZTogTW9kZWwpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuICBjb25zdCBuZXdSZWZJZCA9IGdldE1vZGVsSWQobmV3UmVmZXJlbmNlKTtcbiAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xuICBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX09ORSkge1xuICAgIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIG5ld1JlZklkKTtcbiAgfSBlbHNlIGlmIChyZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fTUFOWSB8fCBpc09ic2VydmFibGVBcnJheShkYXRhKSkge1xuICAgIGRhdGEucHVzaChuZXdSZWZJZCk7XG4gIH0gZWxzZSB7XG4gICAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSwgbmV3UmVmZXJlbmNlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBtb2RlbFJlbW92ZVJlZmVyZW5jZShtb2RlbDogTW9kZWwsIGtleTogc3RyaW5nLCBvbGRSZWZlcmVuY2U6IE1vZGVsKSB7XG4gIGNvbnN0IHJlZk9wdGlvbnMgPSBzdG9yYWdlLmdldE1vZGVsUmVmZXJlbmNlT3B0aW9ucyhtb2RlbCwga2V5KTtcbiAgY29uc3Qgb2xkUmVmSWQgPSBnZXRNb2RlbElkKG9sZFJlZmVyZW5jZSk7XG4gIGNvbnN0IGRhdGEgPSBzdG9yYWdlLmdldE1vZGVsRGF0YUtleShtb2RlbCwga2V5KTtcbiAgaWYgKHJlZk9wdGlvbnMudHlwZSA9PT0gUmVmZXJlbmNlVHlwZS5UT19PTkUpIHtcbiAgICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShtb2RlbCwga2V5LCBudWxsKTtcbiAgfSBlbHNlIGlmIChyZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fTUFOWSB8fCBpc09ic2VydmFibGVBcnJheShkYXRhKSkge1xuICAgIGRhdGEucmVtb3ZlKG9sZFJlZklkKTtcbiAgfSBlbHNlIHtcbiAgICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShtb2RlbCwga2V5LCBudWxsKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJ0aWFsUmVmVXBkYXRlKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcsIGNoYW5nZTogVENoYW5nZSkge1xuICBjb25zdCByZWZPcHRpb25zID0gc3RvcmFnZS5nZXRNb2RlbFJlZmVyZW5jZU9wdGlvbnMobW9kZWwsIGtleSk7XG4gIGNvbnN0IGRhdGEgPSBzdG9yYWdlLmdldE1vZGVsRGF0YUtleShtb2RlbCwga2V5KTtcblxuICBpZiAoY2hhbmdlLnR5cGUgPT09ICdzcGxpY2UnKSB7XG4gICAgY29uc3QgYWRkZWQgPSBjaGFuZ2UuYWRkZWQubWFwKGdldE1vZGVsSWQpO1xuICAgIGRhdGEuc3BsaWNlKGNoYW5nZS5pbmRleCwgY2hhbmdlLnJlbW92ZWRDb3VudCwgLi4uYWRkZWQpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZGF0YVtjaGFuZ2UuaW5kZXhdID0gZ2V0TW9kZWxJZChjaGFuZ2UubmV3VmFsdWUpO1xuICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gYmFja1JlZlNwbGljZShtb2RlbDogTW9kZWwsIGtleTogc3RyaW5nLCBjaGFuZ2U6IElBcnJheVNwbGljZTxNb2RlbD4sIHJlZk9wdGlvbnM6IElSZWZlcmVuY2VPcHRpb25zKSB7XG4gIGNvbnN0IHByb3BlcnR5ID0gcmVmT3B0aW9ucy5wcm9wZXJ0eSBhcyBzdHJpbmc7XG4gIGNoYW5nZS5hZGRlZC5tYXAoKGl0ZW0pID0+IG1vZGVsQWRkUmVmZXJlbmNlKGl0ZW0sIHByb3BlcnR5LCBtb2RlbCkpO1xuICBjb25zdCByZW1vdmVkID0gbW9kZWxba2V5XS5zbGljZShjaGFuZ2UuaW5kZXgsIGNoYW5nZS5pbmRleCArIGNoYW5nZS5yZW1vdmVkQ291bnQpO1xuICByZW1vdmVkLm1hcCgoaXRlbSkgPT4gbW9kZWxSZW1vdmVSZWZlcmVuY2UoaXRlbSwgcHJvcGVydHksIG1vZGVsKSk7XG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBiYWNrUmVmQ2hhbmdlKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcsIGNoYW5nZTogSUFycmF5Q2hhbmdlPE1vZGVsPiwgcmVmT3B0aW9uczogSVJlZmVyZW5jZU9wdGlvbnMpIHtcbiAgY29uc3QgcHJvcGVydHkgPSByZWZPcHRpb25zLnByb3BlcnR5IGFzIHN0cmluZztcbiAgY29uc3Qgb2xkVmFsdWUgPSBtb2RlbFtrZXldLmxlbmd0aCA+IGNoYW5nZS5pbmRleCA/IG1vZGVsW2tleV1bY2hhbmdlLmluZGV4XSA6IG51bGw7XG4gIGlmIChjaGFuZ2UubmV3VmFsdWUpIHtcbiAgICBtb2RlbEFkZFJlZmVyZW5jZShjaGFuZ2UubmV3VmFsdWUsIHByb3BlcnR5LCBtb2RlbCk7XG4gIH1cbiAgaWYgKG9sZFZhbHVlKSB7XG4gICAgbW9kZWxSZW1vdmVSZWZlcmVuY2Uob2xkVmFsdWUsIHByb3BlcnR5LCBtb2RlbCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIHBhcnRpYWxCYWNrUmVmVXBkYXRlKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcsIGNoYW5nZTogVENoYW5nZSkge1xuICBjb25zdCByZWZPcHRpb25zID0gc3RvcmFnZS5nZXRNb2RlbFJlZmVyZW5jZU9wdGlvbnMobW9kZWwsIGtleSk7XG5cbiAgaWYgKGNoYW5nZS50eXBlID09PSAnc3BsaWNlJykge1xuICAgIHJldHVybiBiYWNrUmVmU3BsaWNlKG1vZGVsLCBrZXksIGNoYW5nZSwgcmVmT3B0aW9ucyk7XG4gIH1cbiAgcmV0dXJuIGJhY2tSZWZDaGFuZ2UobW9kZWwsIGtleSwgY2hhbmdlLCByZWZPcHRpb25zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpZWxkKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcpIHtcbiAgcmV0dXJuIHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlRmllbGQobW9kZWw6IE1vZGVsLCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSwgdHlwZTogRmllbGRUeXBlKSB7XG4gIGlmICh0eXBlID09PSBGaWVsZFR5cGUuVFlQRSkge1xuICAgIHRocm93IGVycm9yKFRZUEVfUkVBRE9OTFkpO1xuICB9IGVsc2UgaWYgKHR5cGUgPT09IEZpZWxkVHlwZS5JRCkge1xuICAgIHRocm93IGVycm9yKElEX1JFQURPTkxZKTtcbiAgfVxuICBzdG9yYWdlLnNldE1vZGVsRGF0YUtleShtb2RlbCwga2V5LCB2YWx1ZSk7XG59XG5cbmZ1bmN0aW9uIGhhc0JhY2tSZWYoaXRlbTogTW9kZWwsIHByb3BlcnR5OiBzdHJpbmcsIHRhcmdldDogTW9kZWwpOiBib29sZWFuIHtcbiAgaWYgKGl0ZW1bcHJvcGVydHldID09PSBudWxsIHx8IGl0ZW1bcHJvcGVydHldID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gZWxzZSBpZiAoaXRlbVtwcm9wZXJ0eV0gaW5zdGFuY2VvZiBNb2RlbCkge1xuICAgIHJldHVybiBpdGVtW3Byb3BlcnR5XSA9PT0gdGFyZ2V0O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBpdGVtW3Byb3BlcnR5XS5pbmRleE9mKHRhcmdldCkgIT09IC0xO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEJhY2tSZWYobW9kZWw6IE1vZGVsLCBrZXk6IHN0cmluZywgcmVmT3B0aW9uczogSVJlZmVyZW5jZU9wdGlvbnMpOiBNb2RlbHxBcnJheTxNb2RlbD58bnVsbCB7XG4gIGNvbnN0IHR5cGUgPSBnZXRNb2RlbFR5cGUocmVmT3B0aW9ucy5tb2RlbCk7XG5cbiAgY29uc3QgYWxsTW9kZWxzID0gc3RvcmFnZS5nZXRNb2RlbHNCeVR5cGUodHlwZSk7XG4gIGNvbnN0IGJhY2tNb2RlbHMgPSBPYmplY3Qua2V5cyhhbGxNb2RlbHMpXG4gICAgLm1hcCgoaWQpID0+IGFsbE1vZGVsc1tpZF0pXG4gICAgLmZpbHRlcigoaXRlbSkgPT4gaGFzQmFja1JlZihpdGVtLCByZWZPcHRpb25zLnByb3BlcnR5IGFzIHN0cmluZywgbW9kZWwpKTtcblxuICBjb25zdCBiYWNrRGF0YTogSU9ic2VydmFibGVBcnJheTxNb2RlbD4gPSBvYnNlcnZhYmxlLnNoYWxsb3dBcnJheShiYWNrTW9kZWxzKTtcbiAgaW50ZXJjZXB0KGJhY2tEYXRhLCAoY2hhbmdlOiBUQ2hhbmdlKSA9PiBwYXJ0aWFsQmFja1JlZlVwZGF0ZShtb2RlbCwga2V5LCBjaGFuZ2UpKTtcbiAgcmV0dXJuIGJhY2tEYXRhO1xufVxuXG5mdW5jdGlvbiBnZXROb3JtYWxSZWYobW9kZWw6IE1vZGVsLCBrZXk6IHN0cmluZywgcmVmT3B0aW9uczogSVJlZmVyZW5jZU9wdGlvbnMpOiBNb2RlbHxBcnJheTxNb2RlbD58bnVsbCB7XG4gIGNvbnN0IHZhbHVlID0gc3RvcmFnZS5nZXRNb2RlbERhdGFLZXkobW9kZWwsIGtleSk7XG4gIGNvbnN0IGRhdGFNb2RlbHMgPSBtYXBJdGVtcyh2YWx1ZSwgKGlkKSA9PiBzdG9yYWdlLmZpbmRNb2RlbChyZWZPcHRpb25zLm1vZGVsLCBpZCkpO1xuICBpZiAoZGF0YU1vZGVscyBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgY29uc3QgZGF0YTogSU9ic2VydmFibGVBcnJheTxNb2RlbD4gPSBvYnNlcnZhYmxlLnNoYWxsb3dBcnJheShkYXRhTW9kZWxzKTtcbiAgICBpbnRlcmNlcHQoZGF0YSwgKGNoYW5nZTogVENoYW5nZSkgPT4gcGFydGlhbFJlZlVwZGF0ZShtb2RlbCwga2V5LCBjaGFuZ2UpKTtcbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuICByZXR1cm4gZGF0YU1vZGVscztcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVmKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcpOiBNb2RlbHxBcnJheTxNb2RlbD58bnVsbCB7XG4gIGNvbnN0IHJlZk9wdGlvbnMgPSBzdG9yYWdlLmdldE1vZGVsUmVmZXJlbmNlT3B0aW9ucyhtb2RlbCwga2V5KTtcblxuICByZXR1cm4gKHR5cGVvZiByZWZPcHRpb25zLnByb3BlcnR5ID09PSAnc3RyaW5nJylcbiAgICA/IGdldEJhY2tSZWYobW9kZWwsIGtleSwgcmVmT3B0aW9ucylcbiAgICA6IGdldE5vcm1hbFJlZihtb2RlbCwga2V5LCByZWZPcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVSZWYocmVmT3B0aW9uczogSVJlZmVyZW5jZU9wdGlvbnMsIGlzQXJyYXk6IGJvb2xlYW4sIGtleTogc3RyaW5nKSB7XG4gIGlmIChyZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fT05FICYmIGlzQXJyYXkpIHtcbiAgICB0aHJvdyBlcnJvcihSRUZfU0lOR0xFLCB7a2V5fSk7XG4gIH0gZWxzZSBpZiAocmVmT3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX01BTlkgJiYgIWlzQXJyYXkpIHtcbiAgICB0aHJvdyBlcnJvcihSRUZfQVJSQVksIHtrZXl9KTtcbiAgfSBlbHNlIGlmIChyZWZPcHRpb25zLnByb3BlcnR5KSB7XG4gICAgdGhyb3cgZXJyb3IoQkFDS19SRUZfUkVBRF9PTkxZKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlUmVmKG1vZGVsOiBNb2RlbCwga2V5OiBzdHJpbmcsIHZhbHVlOiBUUmVmVmFsdWUpIHtcbiAgY29uc3QgcmVmT3B0aW9ucyA9IHN0b3JhZ2UuZ2V0TW9kZWxSZWZlcmVuY2VPcHRpb25zKG1vZGVsLCBrZXkpO1xuICBjb25zdCBpZHMgPSByZWZPcHRpb25zLnR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVE9fTUFOWVxuICAgID8gKG1hcEl0ZW1zKHZhbHVlLCBnZXRNb2RlbElkKSB8fCBbXSlcbiAgICA6IG1hcEl0ZW1zKHZhbHVlLCBnZXRNb2RlbElkKTtcblxuICB2YWxpZGF0ZVJlZihyZWZPcHRpb25zLCBpZHMgaW5zdGFuY2VvZiBBcnJheSwga2V5KTtcblxuICBjb25zdCByZWZlcmVuY2VkTW9kZWxzID0gbWFwSXRlbXModmFsdWUsIChyZWYpID0+IHN0b3JhZ2UuZmluZE1vZGVsKHJlZk9wdGlvbnMubW9kZWwsIHJlZikpO1xuXG4gIGNvbnN0IGlzSW52YWxpZEFycmF5ID0gaXNGYWxzeUFycmF5KHJlZmVyZW5jZWRNb2RlbHMpICYmICh2YWx1ZSBhcyBBcnJheTxhbnk+KS5sZW5ndGg7XG4gIGNvbnN0IGlzSW52YWxpZE1vZGVsID0gQm9vbGVhbih2YWx1ZSkgJiYgIXJlZmVyZW5jZWRNb2RlbHM7XG4gIGlmIChpc0ludmFsaWRBcnJheSB8fCBpc0ludmFsaWRNb2RlbCkge1xuICAgIHRocm93IGVycm9yKFJFRl9ORUVEU19DT0xMRUNUSU9OKTtcbiAgfVxuXG4gIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG1vZGVsLCBrZXksIGlkcyk7XG59XG5cbmZ1bmN0aW9uIGdldE1vZGVsUmVmc0J5VHlwZShtb2RlbDogTW9kZWwsIHR5cGU6IElUeXBlKSB7XG4gIGNvbnN0IHJlZnMgPSBzdG9yYWdlLmdldE1vZGVsTWV0YUtleShtb2RlbCwgJ3JlZnMnKTtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKHJlZnMpXG4gICAgLmZpbHRlcigoa2V5KSA9PiAhcmVmc1trZXldLnByb3BlcnR5KVxuICAgIC5maWx0ZXIoKGtleSkgPT4gZ2V0TW9kZWxUeXBlKHJlZnNba2V5XS5tb2RlbCkgPT09IHR5cGUpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVNb2RlbFJlZmVyZW5jZXMobmV3SWQ6IElJZGVudGlmaWVyLCBvbGRJZDogSUlkZW50aWZpZXIsIHR5cGU6IElUeXBlKSB7XG4gIGNvbnN0IGFsbE1vZGVscyA9IHN0b3JhZ2UuZ2V0QWxsTW9kZWxzKCkubWFwKChpdGVtKSA9PiB7XG4gICAgZ2V0TW9kZWxSZWZzQnlUeXBlKGl0ZW0sIHR5cGUpLmZvckVhY2goKHJlZikgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IHN0b3JhZ2UuZ2V0TW9kZWxEYXRhS2V5KGl0ZW0sIHJlZik7XG4gICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5IHx8IGlzT2JzZXJ2YWJsZUFycmF5KGRhdGEpKSB7XG4gICAgICAgIGNvbnN0IHRhcmdldEluZGV4ID0gZGF0YS5pbmRleE9mKG9sZElkKTtcbiAgICAgICAgaWYgKHRhcmdldEluZGV4ICE9PSAtMSkge1xuICAgICAgICAgIGRhdGFbdGFyZ2V0SW5kZXhdID0gbmV3SWQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gb2xkSWQpIHtcbiAgICAgICAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkoaXRlbSwgcmVmLCBuZXdJZCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG4vKipcbiAqIFVwZGF0ZXMgdGhlIG1vZGVsIGlkZW50aWZpZXIgYW5kIGFsbCB0aGUgZXhpc3RpbmcgcmVmZXJlbmNlcyB0byB0aGUgbW9kZWxcbiAqXG4gKiBAZXhwb3J0XG4gKiBAcGFyYW0ge01vZGVsfSBtb2RlbCBNb2RlbCB0byBiZSB1cGRhdGVkXG4gKiBAcGFyYW0ge0lJZGVudGlmaWVyfSBuZXdJZCBOZXcgbW9kZWwgaWRlbnRpZmllclxuICovXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlTW9kZWxJZChtb2RlbDogTW9kZWwsIG5ld0lkOiBJSWRlbnRpZmllcik6IHZvaWQge1xuICBjb25zdCBjb2xsZWN0aW9ucyA9IGdldE1vZGVsQ29sbGVjdGlvbnMobW9kZWwpO1xuXG4gIGNvbnN0IG9sZElkID0gZ2V0TW9kZWxJZChtb2RlbCk7XG4gIGNvbnN0IHR5cGUgPSBnZXRNb2RlbFR5cGUobW9kZWwpO1xuICBzdG9yYWdlLnNldE1vZGVsTWV0YUtleShtb2RlbCwgJ2lkJywgbmV3SWQpO1xuXG4gIGNvbnN0IHN0YXRpY01vZGVsID0gbW9kZWwuY29uc3RydWN0b3IgYXMgdHlwZW9mIE1vZGVsO1xuICBjb25zdCBtb2RlbElkID0gc3RvcmFnZS5nZXRNb2RlbENsYXNzTWV0YUtleShzdGF0aWNNb2RlbCwgJ2lkJyk7XG4gIGlmIChtb2RlbElkKSB7XG4gICAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkobW9kZWwsIG1vZGVsSWQsIG5ld0lkKTtcbiAgfVxuXG4gIGNvbGxlY3Rpb25zLmZvckVhY2goKGNvbGxlY3Rpb24pID0+IHtcbiAgICAvLyBAdHMtaWdub3JlIC0gSSdtIGJhZCBhbmQgSSBzaG91bGQgZmVlbCBiYWQuLi5cbiAgICBjb2xsZWN0aW9uLl9fY2hhbmdlTW9kZWxJZChvbGRJZCwgbmV3SWQsIHR5cGUpO1xuICB9KTtcblxuICB1cGRhdGVNb2RlbFJlZmVyZW5jZXMobmV3SWQsIG9sZElkLCB0eXBlKTtcbn1cbiJdfQ==