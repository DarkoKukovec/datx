"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mobx_1 = require("mobx");
var consts_1 = require("../../consts");
var FieldType_1 = require("../../enums/FieldType");
var ReferenceType_1 = require("../../enums/ReferenceType");
var storage_1 = require("../../services/storage");
var fields_1 = require("./fields");
var utils_1 = require("./utils");
function initModelField(obj, key, defValue, type) {
    if (type === void 0) { type = FieldType_1.FieldType.DATA; }
    var fields = storage_1.storage.getModelMetaKey(obj, 'fields');
    // Initialize the observable field to the default value
    storage_1.storage.setModelDataKey(obj, key, defValue);
    fields.push(key);
    // Set up the computed prop
    mobx_1.extendObservable(obj, (_a = {},
        _a[key] = mobx_1.computed(function () { return fields_1.getField(obj, key); }, function (value) { return fields_1.updateField(obj, key, value, type); }),
        _a));
    var _a;
}
exports.initModelField = initModelField;
/**
 * Initialize a reference to other models
 *
 * @export
 * @template T
 * @param {T} obj Model to which the reference should be added
 * @param {string} key Model property where the reference will be defined
 * @param {IReferenceOptions} options Reference options
 * @param {TRefValue} initialVal Initial reference value
 */
function initModelRef(obj, key, options, initialVal) {
    var refs = storage_1.storage.getModelMetaKey(obj, 'refs');
    // Initialize the observable field to the given value
    refs[key] = options;
    var isArray = options.type === ReferenceType_1.ReferenceType.TO_MANY;
    storage_1.storage.setModelDataKey(obj, key, isArray ? [] : undefined);
    // Set up the computed prop
    mobx_1.extendObservable(obj, (_a = {},
        _a[key] = mobx_1.computed(function () { return fields_1.getRef(obj, key); }, function (value) { return fields_1.updateRef(obj, key, value); }),
        _a));
    if (!options.property) {
        obj[key] = initialVal;
    }
    var _a;
}
exports.initModelRef = initModelRef;
function prepareFields(data, meta, model) {
    var staticModel = model.constructor;
    var fields = meta.fields.slice();
    var classRefs = storage_1.storage.getModelClassReferences(staticModel);
    var refs = Object.assign({}, classRefs, meta.refs);
    var defaults = storage_1.storage.getModelDefaults(staticModel);
    Object.keys(data).concat(Object.keys(defaults))
        .forEach(function (key) {
        if (!(key in refs) && fields.indexOf(key) === -1) {
            fields.push(key);
        }
    });
    return { defaults: defaults, fields: fields, refs: refs };
}
function initModelData(model, data, meta, collection) {
    var _a = prepareFields(data, meta, model), defaults = _a.defaults, fields = _a.fields, refs = _a.refs;
    var staticModel = model.constructor;
    var modelId = storage_1.storage.getModelClassMetaKey(staticModel, 'id');
    var modelType = storage_1.storage.getModelClassMetaKey(staticModel, 'type');
    fields.forEach(function (key) {
        var type = FieldType_1.FieldType.DATA;
        var value = data[key] || defaults[key] || undefined;
        if (key === modelId) {
            type = FieldType_1.FieldType.ID;
            value = meta.id;
        }
        else if (key === modelType) {
            type = FieldType_1.FieldType.TYPE;
            value = meta.type;
        }
        initModelField(model, key, value, type);
    });
    Object.keys(refs).forEach(function (key) {
        var opts = refs[key];
        var value = data[key] || defaults[key] || undefined;
        var models = collection ? collection.add(value, utils_1.getModelType(opts.model)) : value;
        initModelRef(model, key, opts, models);
    });
}
function initModelMeta(model, data) {
    var staticModel = model.constructor;
    var modelId = storage_1.storage.getModelClassMetaKey(staticModel, 'id');
    var modelType = storage_1.storage.getModelClassMetaKey(staticModel, 'type');
    var meta = {
        fields: [],
        id: (modelId && data[modelId]) || staticModel.getAutoId(),
        refs: {},
        type: (modelType && data[modelType]) || utils_1.getModelType(model),
    };
    var newMeta;
    var toInit = { fields: [], refs: {} };
    if (consts_1.META_FIELD in data && data[consts_1.META_FIELD]) {
        var oldMeta = data[consts_1.META_FIELD];
        toInit.fields = oldMeta.fields;
        delete oldMeta.fields;
        toInit.refs = oldMeta.refs;
        delete oldMeta.refs;
        newMeta = storage_1.storage.setModelMeta(model, Object.assign(meta, oldMeta));
        delete data[consts_1.META_FIELD];
    }
    else {
        newMeta = storage_1.storage.setModelMeta(model, meta);
    }
    return Object.assign({}, newMeta, toInit);
}
function initModel(model, rawData, collection) {
    var staticModel = model.constructor;
    var data = Object.assign({}, staticModel.preprocess(rawData));
    var meta = initModelMeta(model, data);
    initModelData(model, data, meta, collection);
}
exports.initModel = initModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9oZWxwZXJzL21vZGVsL2luaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBZ0Q7QUFHaEQsdUNBQXdDO0FBQ3hDLG1EQUFnRDtBQUNoRCwyREFBd0Q7QUFPeEQsa0RBQStDO0FBRS9DLG1DQUFrRTtBQUNsRSxpQ0FBcUM7QUFPckMsd0JBQWdELEdBQU0sRUFBRSxHQUFXLEVBQUUsUUFBYSxFQUFFLElBQWdDO0lBQWhDLHFCQUFBLEVBQUEsT0FBa0IscUJBQVMsQ0FBQyxJQUFJO0lBQ2xILElBQU0sTUFBTSxHQUFHLGlCQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQWtCLENBQUM7SUFFdkUsdURBQXVEO0lBQ3ZELGlCQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUVqQiwyQkFBMkI7SUFDM0IsdUJBQWdCLENBQUMsR0FBRztRQUNsQixHQUFDLEdBQUcsSUFBRyxlQUFRLENBQ2IsY0FBTSxPQUFBLGlCQUFRLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFsQixDQUFrQixFQUN4QixVQUFDLEtBQUssSUFBSyxPQUFBLG9CQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQWxDLENBQWtDLENBQzlDO1lBQ0QsQ0FBQzs7QUFDTCxDQUFDO0FBZEQsd0NBY0M7QUFFRDs7Ozs7Ozs7O0dBU0c7QUFDSCxzQkFBOEMsR0FBTSxFQUFFLEdBQVcsRUFBRSxPQUEwQixFQUFFLFVBQXFCO0lBQ2xILElBQU0sSUFBSSxHQUFHLGlCQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUVsRCxxREFBcUQ7SUFDckQsSUFBSSxDQUFDLEdBQUcsQ0FB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QTBCLEtBQVksRUFBRSxPQUFrQixFQUFFLFVBQXVCO0lBQ2pGLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUEyQixDQUFDO0lBQ3RELElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUNoRSxJQUFNLElBQUksR0FBRyxhQUFhLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3hDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztBQUMvQyxDQUFDO0FBTEQsOEJBS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2NvbXB1dGVkLCBleHRlbmRPYnNlcnZhYmxlfSBmcm9tICdtb2J4JztcblxuaW1wb3J0IHtDb2xsZWN0aW9ufSBmcm9tICcuLi8uLi9Db2xsZWN0aW9uJztcbmltcG9ydCB7TUVUQV9GSUVMRH0gZnJvbSAnLi4vLi4vY29uc3RzJztcbmltcG9ydCB7RmllbGRUeXBlfSBmcm9tICcuLi8uLi9lbnVtcy9GaWVsZFR5cGUnO1xuaW1wb3J0IHtSZWZlcmVuY2VUeXBlfSBmcm9tICcuLi8uLi9lbnVtcy9SZWZlcmVuY2VUeXBlJztcbmltcG9ydCB7TU9ERUxfRVhJU1RTfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xuaW1wb3J0IHtJRGljdGlvbmFyeX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JRGljdGlvbmFyeSc7XG5pbXBvcnQge0lSYXdNb2RlbH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JUmF3TW9kZWwnO1xuaW1wb3J0IHtJUmVmZXJlbmNlT3B0aW9uc30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JUmVmZXJlbmNlT3B0aW9ucyc7XG5pbXBvcnQge1RSZWZWYWx1ZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9UUmVmVmFsdWUnO1xuaW1wb3J0IHtNb2RlbH0gZnJvbSAnLi4vLi4vTW9kZWwnO1xuaW1wb3J0IHtzdG9yYWdlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9zdG9yYWdlJztcbmltcG9ydCB7ZXJyb3J9IGZyb20gJy4uL2Zvcm1hdCc7XG5pbXBvcnQge2dldEZpZWxkLCBnZXRSZWYsIHVwZGF0ZUZpZWxkLCB1cGRhdGVSZWZ9IGZyb20gJy4vZmllbGRzJztcbmltcG9ydCB7Z2V0TW9kZWxUeXBlfSBmcm9tICcuL3V0aWxzJztcblxuaW50ZXJmYWNlIElNZXRhVG9Jbml0IGV4dGVuZHMgSURpY3Rpb25hcnk8YW55PiB7XG4gIGZpZWxkczogQXJyYXk8c3RyaW5nPjtcbiAgcmVmczogSURpY3Rpb25hcnk8SVJlZmVyZW5jZU9wdGlvbnM+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdE1vZGVsRmllbGQ8VCBleHRlbmRzIE1vZGVsPihvYmo6IFQsIGtleTogc3RyaW5nLCBkZWZWYWx1ZTogYW55LCB0eXBlOiBGaWVsZFR5cGUgPSBGaWVsZFR5cGUuREFUQSkge1xuICBjb25zdCBmaWVsZHMgPSBzdG9yYWdlLmdldE1vZGVsTWV0YUtleShvYmosICdmaWVsZHMnKSBhcyBBcnJheTxzdHJpbmc+O1xuXG4gIC8vIEluaXRpYWxpemUgdGhlIG9ic2VydmFibGUgZmllbGQgdG8gdGhlIGRlZmF1bHQgdmFsdWVcbiAgc3RvcmFnZS5zZXRNb2RlbERhdGFLZXkob2JqLCBrZXksIGRlZlZhbHVlKTtcbiAgZmllbGRzLnB1c2goa2V5KTtcblxuICAvLyBTZXQgdXAgdGhlIGNvbXB1dGVkIHByb3BcbiAgZXh0ZW5kT2JzZXJ2YWJsZShvYmosIHtcbiAgICBba2V5XTogY29tcHV0ZWQoXG4gICAgICAoKSA9PiBnZXRGaWVsZChvYmosIGtleSksXG4gICAgICAodmFsdWUpID0+IHVwZGF0ZUZpZWxkKG9iaiwga2V5LCB2YWx1ZSwgdHlwZSksXG4gICAgKSxcbiAgfSk7XG59XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBhIHJlZmVyZW5jZSB0byBvdGhlciBtb2RlbHNcbiAqXG4gKiBAZXhwb3J0XG4gKiBAdGVtcGxhdGUgVFxuICogQHBhcmFtIHtUfSBvYmogTW9kZWwgdG8gd2hpY2ggdGhlIHJlZmVyZW5jZSBzaG91bGQgYmUgYWRkZWRcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTW9kZWwgcHJvcGVydHkgd2hlcmUgdGhlIHJlZmVyZW5jZSB3aWxsIGJlIGRlZmluZWRcbiAqIEBwYXJhbSB7SVJlZmVyZW5jZU9wdGlvbnN9IG9wdGlvbnMgUmVmZXJlbmNlIG9wdGlvbnNcbiAqIEBwYXJhbSB7VFJlZlZhbHVlfSBpbml0aWFsVmFsIEluaXRpYWwgcmVmZXJlbmNlIHZhbHVlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbml0TW9kZWxSZWY8VCBleHRlbmRzIE1vZGVsPihvYmo6IFQsIGtleTogc3RyaW5nLCBvcHRpb25zOiBJUmVmZXJlbmNlT3B0aW9ucywgaW5pdGlhbFZhbDogVFJlZlZhbHVlKSB7XG4gIGNvbnN0IHJlZnMgPSBzdG9yYWdlLmdldE1vZGVsTWV0YUtleShvYmosICdyZWZzJyk7XG5cbiAgLy8gSW5pdGlhbGl6ZSB0aGUgb2JzZXJ2YWJsZSBmaWVsZCB0byB0aGUgZ2l2ZW4gdmFsdWVcbiAgcmVmc1trZXldID0gb3B0aW9ucztcblxuICBjb25zdCBpc0FycmF5ID0gb3B0aW9ucy50eXBlID09PSBSZWZlcmVuY2VUeXBlLlRPX01BTlk7XG4gIHN0b3JhZ2Uuc2V0TW9kZWxEYXRhS2V5KG9iaiwga2V5LCBpc0FycmF5ID8gW10gOiB1bmRlZmluZWQpO1xuXG4gIC8vIFNldCB1cCB0aGUgY29tcHV0ZWQgcHJvcFxuICBleHRlbmRPYnNlcnZhYmxlKG9iaiwge1xuICAgIFtrZXldOiBjb21wdXRlZChcbiAgICAgICgpID0+IGdldFJlZihvYmosIGtleSksXG4gICAgICAodmFsdWUpID0+IHVwZGF0ZVJlZihvYmosIGtleSwgdmFsdWUpLFxuICAgICksXG4gIH0pO1xuXG4gIGlmICghb3B0aW9ucy5wcm9wZXJ0eSkge1xuICAgIG9ialtrZXldID0gaW5pdGlhbFZhbDtcbiAgfVxufVxuXG5mdW5jdGlvbiBwcmVwYXJlRmllbGRzKGRhdGE6IElSYXdNb2RlbCwgbWV0YTogSU1ldGFUb0luaXQsIG1vZGVsOiBNb2RlbCkge1xuICBjb25zdCBzdGF0aWNNb2RlbCA9IG1vZGVsLmNvbnN0cnVjdG9yIGFzIHR5cGVvZiBNb2RlbDtcbiAgY29uc3QgZmllbGRzID0gbWV0YS5maWVsZHMuc2xpY2UoKTtcbiAgY29uc3QgY2xhc3NSZWZzID0gc3RvcmFnZS5nZXRNb2RlbENsYXNzUmVmZXJlbmNlcyhzdGF0aWNNb2RlbCk7XG4gIGNvbnN0IHJlZnMgPSBPYmplY3QuYXNzaWduKHt9LCBjbGFzc1JlZnMsIG1ldGEucmVmcyk7XG5cbiAgY29uc3QgZGVmYXVsdHMgPSBzdG9yYWdlLmdldE1vZGVsRGVmYXVsdHMoc3RhdGljTW9kZWwpO1xuXG4gIE9iamVjdC5rZXlzKGRhdGEpLmNvbmNhdChPYmplY3Qua2V5cyhkZWZhdWx0cykpXG4gICAgLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgaWYgKCEoa2V5IGluIHJlZnMpICYmIGZpZWxkcy5pbmRleE9mKGtleSkgPT09IC0xKSB7XG4gICAgICAgIGZpZWxkcy5wdXNoKGtleSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgcmV0dXJuIHtkZWZhdWx0cywgZmllbGRzLCByZWZzfTtcbn1cblxuZnVuY3Rpb24gaW5pdE1vZGVsRGF0YShtb2RlbDogTW9kZWwsIGRhdGE6IElSYXdNb2RlbCwgbWV0YTogSU1ldGFUb0luaXQsIGNvbGxlY3Rpb24/OiBDb2xsZWN0aW9uKSB7XG4gIGNvbnN0IHtkZWZhdWx0cywgZmllbGRzLCByZWZzfSA9IHByZXBhcmVGaWVsZHMoZGF0YSwgbWV0YSwgbW9kZWwpO1xuXG4gIGNvbnN0IHN0YXRpY01vZGVsID0gbW9kZWwuY29uc3RydWN0b3IgYXMgdHlwZW9mIE1vZGVsO1xuICBjb25zdCBtb2RlbElkID0gc3RvcmFnZS5nZXRNb2RlbENsYXNzTWV0YUtleShzdGF0aWNNb2RlbCwgJ2lkJyk7XG4gIGNvbnN0IG1vZGVsVHlwZSA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICd0eXBlJyk7XG5cbiAgZmllbGRzLmZvckVhY2goKGtleSkgPT4ge1xuICAgIGxldCB0eXBlID0gRmllbGRUeXBlLkRBVEE7XG4gICAgbGV0IHZhbHVlID0gZGF0YVtrZXldIHx8IGRlZmF1bHRzW2tleV0gfHwgdW5kZWZpbmVkO1xuICAgIGlmIChrZXkgPT09IG1vZGVsSWQpIHtcbiAgICAgIHR5cGUgPSBGaWVsZFR5cGUuSUQ7XG4gICAgICB2YWx1ZSA9IG1ldGEuaWQ7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09IG1vZGVsVHlwZSkge1xuICAgICAgdHlwZSA9IEZpZWxkVHlwZS5UWVBFO1xuICAgICAgdmFsdWUgPSBtZXRhLnR5cGU7XG4gICAgfVxuICAgIGluaXRNb2RlbEZpZWxkKG1vZGVsLCBrZXksIHZhbHVlLCB0eXBlKTtcbiAgfSk7XG5cbiAgT2JqZWN0LmtleXMocmVmcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3Qgb3B0cyA9IHJlZnNba2V5XTtcbiAgICBjb25zdCB2YWx1ZSA9IGRhdGFba2V5XSB8fCBkZWZhdWx0c1trZXldIHx8IHVuZGVmaW5lZDtcbiAgICBsZXQgbW9kZWxzOiBhbnkgPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5hZGQodmFsdWUsIGdldE1vZGVsVHlwZShvcHRzLm1vZGVsKSkgOiB2YWx1ZTtcbiAgICBpbml0TW9kZWxSZWYobW9kZWwsIGtleSwgb3B0cywgbW9kZWxzKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGluaXRNb2RlbE1ldGEobW9kZWw6IE1vZGVsLCBkYXRhOiBJUmF3TW9kZWwpOiBJRGljdGlvbmFyeTxhbnk+ICYgSU1ldGFUb0luaXQge1xuICBjb25zdCBzdGF0aWNNb2RlbCA9IG1vZGVsLmNvbnN0cnVjdG9yIGFzIHR5cGVvZiBNb2RlbDtcbiAgY29uc3QgbW9kZWxJZCA9IHN0b3JhZ2UuZ2V0TW9kZWxDbGFzc01ldGFLZXkoc3RhdGljTW9kZWwsICdpZCcpO1xuICBjb25zdCBtb2RlbFR5cGUgPSBzdG9yYWdlLmdldE1vZGVsQ2xhc3NNZXRhS2V5KHN0YXRpY01vZGVsLCAndHlwZScpO1xuXG4gIGNvbnN0IG1ldGEgPSB7XG4gICAgZmllbGRzOiBbXSxcbiAgICBpZDogKG1vZGVsSWQgJiYgZGF0YVttb2RlbElkXSkgfHwgc3RhdGljTW9kZWwuZ2V0QXV0b0lkKCksXG4gICAgcmVmczoge30sXG4gICAgdHlwZTogKG1vZGVsVHlwZSAmJiBkYXRhW21vZGVsVHlwZV0pIHx8IGdldE1vZGVsVHlwZShtb2RlbCksXG4gIH07XG5cbiAgbGV0IG5ld01ldGE7XG4gIGNvbnN0IHRvSW5pdDogSU1ldGFUb0luaXQgPSB7ZmllbGRzOiBbXSwgcmVmczoge319O1xuICBpZiAoTUVUQV9GSUVMRCBpbiBkYXRhICYmIGRhdGFbTUVUQV9GSUVMRF0pIHtcblxuICAgIGNvbnN0IG9sZE1ldGEgPSBkYXRhW01FVEFfRklFTERdIGFzIElEaWN0aW9uYXJ5PGFueT47XG4gICAgdG9Jbml0LmZpZWxkcyA9IG9sZE1ldGEuZmllbGRzO1xuICAgIGRlbGV0ZSBvbGRNZXRhLmZpZWxkcztcbiAgICB0b0luaXQucmVmcyA9IG9sZE1ldGEucmVmcztcbiAgICBkZWxldGUgb2xkTWV0YS5yZWZzO1xuXG4gICAgbmV3TWV0YSA9IHN0b3JhZ2Uuc2V0TW9kZWxNZXRhKG1vZGVsLCBPYmplY3QuYXNzaWduKG1ldGEsIG9sZE1ldGEpKTtcbiAgICBkZWxldGUgZGF0YVtNRVRBX0ZJRUxEXTtcbiAgfSBlbHNlIHtcbiAgICBuZXdNZXRhID0gc3RvcmFnZS5zZXRNb2RlbE1ldGEobW9kZWwsIG1ldGEpO1xuICB9XG4gIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBuZXdNZXRhLCB0b0luaXQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdE1vZGVsKG1vZGVsOiBNb2RlbCwgcmF3RGF0YTogSVJhd01vZGVsLCBjb2xsZWN0aW9uPzogQ29sbGVjdGlvbikge1xuICBjb25zdCBzdGF0aWNNb2RlbCA9IG1vZGVsLmNvbnN0cnVjdG9yIGFzIHR5cGVvZiBNb2RlbDtcbiAgY29uc3QgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIHN0YXRpY01vZGVsLnByZXByb2Nlc3MocmF3RGF0YSkpO1xuICBjb25zdCBtZXRhID0gaW5pdE1vZGVsTWV0YShtb2RlbCwgZGF0YSk7XG4gIGluaXRNb2RlbERhdGEobW9kZWwsIGRhdGEsIG1ldGEsIGNvbGxlY3Rpb24pO1xufVxuIl19